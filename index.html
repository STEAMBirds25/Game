<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1: Rescue Version</title>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; background: #111; color: white; font-family: sans-serif; }
        #debug-info { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid red; pointer-events: none; }
        #controls-ui { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; }
        .btn { width: 80px; height: 80px; background: rgba(255,255,255,0.1); border: 2px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; pointer-events: auto; }
        .btn:active { background: white; color: black; }
    </style>
</head>
<body>

    <div id="debug-info">
        <h3>MODO DIAGNÓSTICO</h3>
        <p>Si ves cajas verdes = Físicas OK</p>
        <p>Si no ves el coche = Ajustar SCALE_FACTOR</p>
        <p>Velocidad: <span id="speed">0</span> km/h</p>
    </div>

    <div id="controls-ui">
        <div id="btn-left" class="btn">◀</div>
        <div id="btn-brake" class="btn" style="border-color:red">FREN</div>
        <div id="btn-gas" class="btn" style="border-color:lime">GAS</div>
        <div id="btn-right" class="btn">▶</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import * as CANNON from 'cannon-es';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

        // --- CONFIGURACIÓN DE EMERGENCIA ---
        // Empieza con 1.0. Si no ves nada, prueba 0.01 o 100.
        const SCALE_FACTOR = 0.01; 
        
        // Nombres de archivos
        const FILE_CHASIS = 'chasis.fbx';
        const FILE_RUEDA  = 'rueda.fbx';
        // ------------------------------------

        // Inputs
        const keys = { w:0, a:0, s:0, d:0 };
        const touch = { w:0, a:0, s:0, d:0 };

        // 1. ESCENA
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x202020);
        scene.add(new THREE.GridHelper(500, 50)); // Suelo guía
        scene.add(new THREE.AxesHelper(5)); // Ejes (Rojo=X, Verde=Y, Azul=Z)

        // Luces (Muy fuertes para ver modelos negros)
        const ambLight = new THREE.AmbientLight(0xffffff, 1.0);
        scene.add(ambLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10); // Cámara alta y lejos

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 2. FÍSICAS (CANNON)
        const world = new CANNON.World();
        world.gravity.set(0, -9.82, 0);
        world.broadphase = new CANNON.SAPBroadphase(world);

        const groundBody = new CANNON.Body({ mass: 0 });
        groundBody.addShape(new CANNON.Plane());
        groundBody.quaternion.setFromEuler(-Math.PI/2, 0, 0);
        world.addBody(groundBody);

        // CHASIS FÍSICO
        const chassisShape = new CANNON.Box(new CANNON.Vec3(0.8, 0.25, 2.0)); // Tamaño aprox de un F1
        const chassisBody = new CANNON.Body({ mass: 150 });
        chassisBody.addShape(chassisShape, new CANNON.Vec3(0, 0.5, 0));
        chassisBody.position.set(0, 2, 0);
        chassisBody.angularDamping = 0.5;

        // VISUALIZADOR DE FÍSICAS (CAJA VERDE)
        // Esto crea una caja de alambre verde donde está el cuerpo físico.
        // Si ves esto, el juego funciona.
        const debugChassisGeo = new THREE.BoxGeometry(1.6, 0.5, 4.0);
        const debugChassisMat = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
        const debugChassisMesh = new THREE.Mesh(debugChassisGeo, debugChassisMat);
        scene.add(debugChassisMesh);

        // VEHÍCULO
        const vehicle = new CANNON.RaycastVehicle({
            chassisBody: chassisBody,
            indexRightAxis: 0, indexUpAxis: 1, indexForwardAxis: 2
        });

        const wheelOptions = {
            radius: 0.4,
            directionLocal: new CANNON.Vec3(0, -1, 0),
            suspensionStiffness: 30,
            suspensionRestLength: 0.3,
            frictionSlip: 1.4,
            dampingRelaxation: 2.3,
            dampingCompression: 4.4,
            maxSuspensionForce: 100000,
            rollInfluence: 0.01,
            axleLocal: new CANNON.Vec3(-1, 0, 0),
            chassisConnectionPointLocal: new CANNON.Vec3(0, 0, 0),
            maxSuspensionTravel: 0.3,
            customSlidingRotationalSpeed: -30,
            useCustomSlidingRotationalSpeed: true
        };

        // Añadir ruedas (Posiciones fijas para probar)
        wheelOptions.chassisConnectionPointLocal.set(1.0, 0, 1.5); vehicle.addWheel(wheelOptions);
        wheelOptions.chassisConnectionPointLocal.set(-1.0, 0, 1.5); vehicle.addWheel(wheelOptions);
        wheelOptions.chassisConnectionPointLocal.set(1.0, 0, -1.5); vehicle.addWheel(wheelOptions);
        wheelOptions.chassisConnectionPointLocal.set(-1.0, 0, -1.5); vehicle.addWheel(wheelOptions);

        vehicle.addToWorld(world);

        // 3. CARGADOR DE MODELOS (CON FIX DE CENTRADO)
        const loader = new FBXLoader();
        const chassisVisuals = new THREE.Group();
        scene.add(chassisVisuals);
        
        const wheelVisuals = []; // Array de meshes de ruedas

        // CARGAR CHASIS
        loader.load(`./models/${FILE_CHASIS}`, (obj) => {
            console.log("Chasis cargado");
            obj.scale.set(SCALE_FACTOR, SCALE_FACTOR, SCALE_FACTOR);
            obj.rotation.y = Math.PI; // Girar 180 si mira atrás
            // Corrección visual de altura
            obj.position.y = -0.5; 
            chassisVisuals.add(obj);
        }, undefined, (e) => console.error("Error Chasis:", e));

        // CARGAR RUEDA (SOLUCIÓN PANDEO)
        loader.load(`./models/${FILE_RUEDA}`, (rawModel) => {
            console.log("Rueda cargada");
            
            // 1. Encontrar la malla real
            let mesh = null;
            rawModel.traverse(c => { if(c.isMesh && !mesh) mesh = c; });

            if(mesh) {
                // 2. FORZAR CENTRADO GEOMÉTRICO
                // Esto mueve los vértices para que el centro sea 0,0,0. Adiós pandeo.
                mesh.geometry.center(); 
                
                // 3. Crear 4 clones
                for(let i=0; i<4; i++) {
                    const w = new THREE.Mesh(mesh.geometry, mesh.material);
                    w.scale.set(SCALE_FACTOR, SCALE_FACTOR, SCALE_FACTOR);
                    
                    // Si las traseras deben ser más grandes:
                    if(i >= 2) w.scale.multiplyScalar(1.3);

                    w.castShadow = true;
                    scene.add(w);
                    wheelVisuals.push(w);
                }
            }
        }, undefined, (e) => console.error("Error Rueda:", e));


        // 4. CONTROLES
        // Teclado
        window.onkeydown = (e) => {
            const k = e.key.toLowerCase();
            if(k==='w') keys.w=1; if(k==='s') keys.s=1; if(k==='a') keys.a=1; if(k==='d') keys.d=1;
            if(k==='r') { chassisBody.position.set(0,3,0); chassisBody.quaternion.set(0,0,0,1); chassisBody.velocity.set(0,0,0); chassisBody.angularVelocity.set(0,0,0); }
        };
        window.onkeyup = (e) => {
            const k = e.key.toLowerCase();
            if(k==='w') keys.w=0; if(k==='s') keys.s=0; if(k==='a') keys.a=0; if(k==='d') keys.d=0;
        };

        // Botones UI
        const bind = (id, k) => {
            const el = document.getElementById(id);
            el.onmousedown = el.ontouchstart = (e) => { e.preventDefault(); touch[k]=1; el.style.background='white'; el.style.color='black'; };
            el.onmouseup = el.onmouseleave = el.ontouchend = (e) => { e.preventDefault(); touch[k]=0; el.style.background='rgba(255,255,255,0.1)'; el.style.color='white'; };
        };
        bind('btn-gas', 'w'); bind('btn-brake', 's'); bind('btn-left', 'a'); bind('btn-right', 'd');


        // 5. ANIMACIÓN
        function animate() {
            requestAnimationFrame(animate);

            // Inputs combinados
            const gas = Math.max(keys.w, touch.w);
            const brake = Math.max(keys.s, touch.s);
            const steer = (keys.a || touch.a) ? 1 : (keys.d || touch.d) ? -1 : 0; // Izq=Positivo en este setup básico

            // Aplicar fuerzas
            vehicle.applyEngineForce(-gas * 2000, 2);
            vehicle.applyEngineForce(-gas * 2000, 3);
            
            vehicle.setBrake(brake * 100, 0); vehicle.setBrake(brake * 100, 1);
            vehicle.setBrake(brake * 100, 2); vehicle.setBrake(brake * 100, 3);

            vehicle.setSteeringValue(steer * 0.5, 0);
            vehicle.setSteeringValue(steer * 0.5, 1);

            world.fixedStep();

            // Sincronizar Chasis Visual
            chassisVisuals.position.copy(chassisBody.position);
            chassisVisuals.quaternion.copy(chassisBody.quaternion);
            
            // Sincronizar Debug Box (Caja Verde)
            debugChassisMesh.position.copy(chassisBody.position);
            debugChassisMesh.quaternion.copy(chassisBody.quaternion);

            // Sincronizar Ruedas
            for(let i=0; i<4; i++) {
                vehicle.updateWheelTransform(i);
                if(wheelVisuals[i]) {
                    wheelVisuals[i].position.copy(vehicle.wheelInfos[i].worldTransform.position);
                    wheelVisuals[i].quaternion.copy(vehicle.wheelInfos[i].worldTransform.quaternion);
                }
            }

            // Cámara Chase simple
            const camOffset = new THREE.Vector3(0, 4, -8).applyMatrix4(debugChassisMesh.matrixWorld);
            camera.position.lerp(camOffset, 0.1);
            camera.lookAt(chassisBody.position);

            document.getElementById('speed').innerText = Math.floor(chassisBody.velocity.length() * 3.6);
            renderer.render(scene, camera);
        }

        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
