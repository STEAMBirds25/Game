// --- 1. LÓGICA DE POSICIÓN DEL PEDAL (Freno a la derecha en Slider) ---
function setupMobileMode(mode) {
    config.mobileMode = mode;
    const steerZone = document.getElementById('steering-zone');
    const brakePedal = document.getElementById('vis-brake');
    const gasPedal = document.getElementById('vis-gas');

    if (mode === 'slide') { 
        steerZone.style.display = 'flex'; 
        document.getElementById('opt-slide').className = 'option-btn active-opt'; 
        document.getElementById('opt-gyro').className = 'option-btn';
        
        // Mover freno a la derecha (junto al acelerador)
        brakePedal.style.left = 'auto';
        brakePedal.style.right = '230px'; // Posición junto al gas
    } else { 
        steerZone.style.display = 'none'; 
        document.getElementById('opt-gyro').className = 'option-btn active-opt'; 
        document.getElementById('opt-slide').className = 'option-btn';
        
        // Freno vuelve a la izquierda (Modo Gyro/Standard)
        brakePedal.style.right = 'auto';
        brakePedal.style.left = '20px';
        
        if(typeof DeviceOrientationEvent?.requestPermission==='function') DeviceOrientationEvent.requestPermission(); 
    }
}

// --- 2. FÍSICA DE SUSPENSIÓN Y DOWNFORCE (v10.4) ---
const vehicle = new CANNON.RaycastVehicle({ 
    chassisBody: chassisBody, 
    indexRightAxis: 0, 
    indexUpAxis: 1, 
    indexForwardAxis: 2 
});

const wOpts = { 
    radius: 0.38, 
    directionLocal: new CANNON.Vec3(0, -1, 0), 
    axleLocal: new CANNON.Vec3(-1, 0, 0),
    suspensionStiffness: 60,          // Suspensión de competición
    suspensionRestLength: 0.5, 
    frictionSlip: 3.8,                // Grip máximo
    dampingRelaxation: 9.0,           // Rebote controlado
    dampingCompression: 6.0,          // Absorción de baches
    maxSuspensionForce: 100000, 
    chassisConnectionPointLocal: new CANNON.Vec3(0, 0, 0), 
    maxSuspensionTravel: 0.2, 
    useCustomSlidingRotationalSpeed: true, 
    customSlidingRotationalSpeed: -30 
};

// ... (Aquí van los vehicle.addWheel con tus posiciones originales)

// --- 3. DENTRO DEL LOOP ANIMATE ---
function animate() {
    // ... (tus inputs previos)

    const enginePower = 4000;
    vehicle.applyEngineForce(-inputs.gas * enginePower, 2); 
    vehicle.applyEngineForce(-inputs.gas * enginePower, 3);
    
    // Frenos optimizados
    vehicle.setBrake(inputs.brake * 150, 0); 
    vehicle.setBrake(inputs.brake * 150, 1);
    vehicle.setBrake(inputs.brake * 300, 2); // Más freno atrás para estabilidad
    vehicle.setBrake(inputs.brake * 300, 3);
    
    vehicle.setSteeringValue(inputs.steer * 0.75, 0); 
    vehicle.setSteeringValue(inputs.steer * 0.75, 1);

    // DOWNFORCE: El "efecto suelo" que pega el coche
    const speed = chassisBody.velocity.length();
    if(speed > 4) {
        // Aplicamos 200 Newtons por cada m/s de velocidad
        chassisBody.applyLocalForce(new CANNON.Vec3(0, -speed * 200, 0), new CANNON.Vec3(0, 0, 0));
    }

    world.fixedStep();
    // ... (renderizado)
}
