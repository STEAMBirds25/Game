<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F1: BUSCADOR DE MODELOS</title>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: sans-serif; user-select: none; }
        
        #debug-panel {
            position: absolute; top: 10px; right: 10px; width: 280px;
            background: rgba(0, 0, 0, 0.9); color: white; padding: 15px;
            border: 2px solid yellow; border-radius: 8px; font-size: 12px;
            z-index: 5000; pointer-events: auto; display: flex; flex-direction: column; gap: 10px;
        }
        .debug-row { display: flex; justify-content: space-between; align-items: center; }
        input[type=range] { width: 140px; cursor: pointer; }
        h3 { margin: 0 0 5px 0; text-align: center; color: yellow; border-bottom: 1px solid yellow; }
        .status { font-weight: bold; font-size: 14px; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
    </style>
</head>
<body>

    <div id="debug-panel">
        <h3>游댌 BUSCADOR DE COCHE</h3>
        
        <div class="debug-row" style="background:#333; padding:5px;">
            <span>ESTADO CARGA:</span> 
            <span id="load-status" class="status" style="color:orange">Cargando...</span>
        </div>

        <div class="debug-row" style="border-bottom:1px solid #555; padding-bottom:10px;">
            <strong style="color:yellow">1. TAMA칌O TOTAL:</strong> 
            <!-- Este slider va de 0.001 a 5.0 logar칤tmicamente simulado -->
            <input type="range" id="sl-scale" min="0" max="100" step="1" value="50"> 
            <span id="val-scale">1.0</span>
        </div>
        
        <div class="debug-row">
            <span>2. ANCHO EJES:</span> 
            <input type="range" id="sl-x" min="0.5" max="3.0" step="0.05" value="1.1"> 
        </div>
        
        <div class="debug-row">
            <span>3. ALTURA VISUAL:</span> 
            <input type="range" id="sl-vy" min="-5.0" max="5.0" step="0.1" value="-0.5"> 
        </div>

        <p style="text-align:center; color:#aaa;">Si ves cajas verdes, las f칤sicas funcionan.<br>Mueve el "TAMA칌O TOTAL" hasta ver el coche.</p>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import * as CANNON from 'cannon-es';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

        // --- NOMBRES DE ARCHIVOS ---
        const ARCHIVO_CHASIS = 'chasis.fbx';
        const ARCHIVO_RUEDA  = 'rueda.fbx';

        // Variables globales para manipulaci칩n
        let visualChasis = null;
        let visualWheels = [];
        let currentScale = 1.0;

        const statusEl = document.getElementById('load-status');

        // 1. ESCENA
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0x303030);
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 5000); // View distance huge
        camera.position.set(0, 5, 10);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // LUCES EXTREMAS (Para asegurar que se vea aunque sea negro)
        const sun = new THREE.DirectionalLight(0xffffff, 3); sun.position.set(10, 50, 10); scene.add(sun);
        scene.add(new THREE.AmbientLight(0xffffff, 2.0)); // Luz ambiental muy fuerte
        scene.add(new THREE.GridHelper(100, 100)); 
        scene.add(new THREE.AxesHelper(5)); // Ejes de colores

        // 2. F칈SICAS (Cajas verdes)
        const world = new CANNON.World(); world.gravity.set(0, -9.82, 0); 
        const groundMat = new CANNON.Material(); const wheelMat = new CANNON.Material();
        world.addContactMaterial(new CANNON.ContactMaterial(wheelMat, groundMat, { friction: 3, restitution: 0 }));
        
        const gb = new CANNON.Body({ mass: 0, material: groundMat });
        gb.addShape(new CANNON.Plane()); gb.quaternion.setFromEuler(-Math.PI/2, 0, 0); world.addBody(gb);

        // Chasis F칤sico
        const chassisBody = new CANNON.Body({ mass: 150, material: groundMat });
        chassisBody.addShape(new CANNON.Box(new CANNON.Vec3(0.8, 0.25, 2.0)), new CANNON.Vec3(0, 0.5, 0));
        chassisBody.position.set(0, 2, 0);
        
        // Debug Visual (Caja verde)
        const debugGeo = new THREE.BoxGeometry(1.6, 0.5, 4.0);
        const debugMat = new THREE.MeshBasicMaterial({color: 0x00ff00, wireframe: true});
        const debugMesh = new THREE.Mesh(debugGeo, debugMat);
        scene.add(debugMesh);

        // Veh칤culo
        const vehicle = new CANNON.RaycastVehicle({ chassisBody: chassisBody, indexRightAxis: 0, indexUpAxis: 1, indexForwardAxis: 2 });
        const wOpts = { radius: 0.4, directionLocal: new CANNON.Vec3(0,-1,0), suspensionStiffness: 30, suspensionRestLength: 0.3, frictionSlip: 5, dampingRelaxation: 2.3, dampingCompression: 4.4, maxSuspensionForce: 100000, axleLocal: new CANNON.Vec3(-1,0,0), chassisConnectionPointLocal: new CANNON.Vec3(0,0,0), maxSuspensionTravel: 0.3, useCustomSlidingRotationalSpeed: true, customSlidingRotationalSpeed: -30 };

        // 4 Ruedas
        wOpts.chassisConnectionPointLocal.set(1, 0, 1.5); vehicle.addWheel(wOpts);
        wOpts.chassisConnectionPointLocal.set(-1, 0, 1.5); vehicle.addWheel(wOpts);
        wOpts.chassisConnectionPointLocal.set(1, 0, -1.5); vehicle.addWheel(wOpts);
        wOpts.chassisConnectionPointLocal.set(-1, 0, -1.5); vehicle.addWheel(wOpts);
        vehicle.addToWorld(world);

        // 3. CARGADORES FBX
        const loader = new FBXLoader();

        // Cargar Chasis
        loader.load(`./models/${ARCHIVO_CHASIS}`, (obj) => {
            statusEl.innerText = "Chasis OK...";
            // Asegurar material visible
            obj.traverse(c => { if(c.isMesh) { c.material.side = THREE.DoubleSide; } });
            visualChasis = obj;
            scene.add(visualChasis);
        }, undefined, (e) => {
            console.error(e);
            statusEl.innerText = "ERROR Chasis";
            statusEl.style.color = "red";
        });

        // Cargar Rueda
        loader.load(`./models/${ARCHIVO_RUEDA}`, (raw) => {
            statusEl.innerText = "Todo OK";
            statusEl.style.color = "lime";

            // AUTO-CENTRADO (Anti-pandeo)
            let mesh = null;
            raw.traverse(c => { if(c.isMesh && !mesh) mesh = c; });
            if(mesh) {
                mesh.geometry.center(); // Centrar geometr칤a
                
                // Clonar
                for(let i=0; i<4; i++) {
                    const w = new THREE.Mesh(mesh.geometry, mesh.material);
                    scene.add(w);
                    visualWheels.push(w);
                }
            }
        }, undefined, (e) => {
            statusEl.innerText = "ERROR Rueda";
            statusEl.style.color = "red";
        });

        // --- CALIBRACI칍N EN VIVO ---
        function updateFromSliders() {
            // 1. Calcular escala logar칤tmica (para tener mucho rango)
            // Slider 0-100 mapeado a: 0.001 -> 10.0
            const sliderVal = parseFloat(document.getElementById('sl-scale').value);
            
            // F칩rmula: Si slider < 50, escala peque침a. Si > 50, escala grande.
            // Esto permite probar escalas microsc칩picas y gigantes.
            if(sliderVal < 50) {
                currentScale = 0.001 + (sliderVal / 50) * 0.999; // 0.001 a 1.0
            } else {
                currentScale = 1.0 + ((sliderVal - 50) / 50) * 10; // 1.0 a 11.0
            }
            
            // Actualizar texto
            document.getElementById('val-scale').innerText = currentScale.toFixed(3);

            // 2. Leer otros valores
            const widthX = parseFloat(document.getElementById('sl-x').value);
            const visualY = parseFloat(document.getElementById('sl-vy').value);

            // 3. Aplicar al CHASIS
            if(visualChasis) {
                visualChasis.scale.set(currentScale, currentScale, currentScale);
                visualChasis.rotation.y = Math.PI; // Mirar al frente
                
                // Mover visualmente el chasis relativo a la caja f칤sica
                const offset = new THREE.Vector3(0, visualY, 0).applyQuaternion(chassisBody.quaternion);
                visualChasis.position.copy(chassisBody.position).add(offset);
                visualChasis.quaternion.copy(chassisBody.quaternion);
            }

            // 4. Aplicar a las RUEDAS F칈SICAS (Abrirlas/Cerrarlas)
            // Solo modificamos el ancho X basado en el slider
            vehicle.wheelInfos[0].chassisConnectionPointLocal.x = widthX;
            vehicle.wheelInfos[1].chassisConnectionPointLocal.x = -widthX;
            vehicle.wheelInfos[2].chassisConnectionPointLocal.x = widthX;
            vehicle.wheelInfos[3].chassisConnectionPointLocal.x = -widthX;

            // 5. Aplicar a las RUEDAS VISUALES
            for(let i=0; i<4; i++) {
                if(visualWheels[i]) {
                    visualWheels[i].scale.set(currentScale, currentScale, currentScale);
                    // Traseras m치s grandes
                    if(i>=2) visualWheels[i].scale.multiplyScalar(1.3);
                    
                    // Copiar posici칩n de f칤sica
                    vehicle.updateWheelTransform(i);
                    visualWheels[i].position.copy(vehicle.wheelInfos[i].worldTransform.position);
                    visualWheels[i].quaternion.copy(vehicle.wheelInfos[i].worldTransform.quaternion);
                }
            }
        }

        // --- ANIMACI칍N ---
        function animate() {
            requestAnimationFrame(animate);
            world.fixedStep();

            // Sincronizar Debug Box
            debugMesh.position.copy(chassisBody.position);
            debugMesh.quaternion.copy(chassisBody.quaternion);

            // Ejecutar calibraci칩n cada frame
            updateFromSliders();

            // C치mara simple que sigue al coche
            camera.lookAt(chassisBody.position);

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
        });

    </script>
</body>
</html>
