<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F1: CALIBRADOR</title>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background: #333; font-family: sans-serif; user-select: none; }
        
        /* PANEL DE CALIBRACI칍N */
        #debug-panel {
            position: absolute; top: 10px; right: 10px; width: 250px;
            background: rgba(0, 20, 60, 0.9); color: white; padding: 10px;
            border: 2px solid cyan; border-radius: 8px; font-size: 12px;
            z-index: 5000; pointer-events: auto; display: flex; flex-direction: column; gap: 8px;
        }
        .debug-row { display: flex; justify-content: space-between; align-items: center; }
        input[type=range] { width: 120px; cursor: pointer; }
        h3 { margin: 0 0 5px 0; text-align: center; color: cyan; border-bottom: 1px solid cyan; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #speed-box { position: absolute; top: 20px; left: 20px; color: cyan; font-size: 30px; font-weight: bold; font-family: monospace; }
        
        .controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-around; pointer-events: auto; }
        .btn { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border: 2px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: white; }
        .btn:active { background: white; color: black; }
    </style>
</head>
<body>

    <!-- PANEL DE CALIBRACI칍N -->
    <div id="debug-panel">
        <h3>游댢 CALIBRADOR</h3>
        
        <div class="debug-row">
            <span>ANCHO (X):</span> 
            <input type="range" id="sl-x" min="0.5" max="3.0" step="0.05" value="1.1"> 
            <span id="val-x">1.1</span>
        </div>
        
        <div class="debug-row">
            <span>ALTURA (Y):</span> 
            <input type="range" id="sl-y" min="-1.0" max="1.5" step="0.05" value="0.2"> 
            <span id="val-y">0.2</span>
        </div>

        <div class="debug-row">
            <span>LARGO (Z):</span> 
            <input type="range" id="sl-z" min="0.5" max="3.0" step="0.05" value="1.6"> 
            <span id="val-z">1.6</span>
        </div>

        <div class="debug-row">
            <span>VISUAL Y:</span> 
            <input type="range" id="sl-vy" min="-2.0" max="2.0" step="0.05" value="-0.5"> 
            <span id="val-vy">-0.5</span>
        </div>

        <div class="debug-row">
            <span>ROT RUEDA:</span> 
            <input type="range" id="sl-rx" min="0" max="6.28" step="1.57" value="0"> 
            <span id="val-rx">0</span>
        </div>

        <div style="font-size:10px; color:#aaa; margin-top:5px; text-align:center;">
            Ajusta los sliders hasta que encaje.<br>Anota los n칰meros.
        </div>
    </div>

    <div id="ui-layer">
        <div id="speed-box">0 KM/H</div>
        <div class="controls">
            <div id="btn-gas" class="btn" style="border-color:lime">GAS</div>
            <div id="btn-brake" class="btn" style="border-color:red">FRE</div>
            <div id="btn-left" class="btn">Iz</div>
            <div id="btn-right" class="btn">De</div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import * as CANNON from 'cannon-es';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

        // --- NOMBRES DE ARCHIVOS ---
        const FILE_CHASIS = 'chasis.fbx';
        const FILE_RUEDA  = 'rueda.fbx';
        
        // --- ESCALA GLOBAL (Si ves el coche gigante, baja esto a 0.01) ---
        const GLOBAL_SCALE = 2.0; 

        // Variables de calibraci칩n (Se actualizan con los sliders)
        const cal = { x: 1.1, y: 0.2, z: 1.6, visualY: -0.5, rotX: 0 };

        // Inputs
        const keys = { w:0, s:0, a:0, d:0 };

        // 1. ESCENA
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0x222);
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Luces (Muy fuertes para ver todo)
        const sun = new THREE.DirectionalLight(0xffffff, 2); sun.position.set(10, 20, 10); scene.add(sun);
        scene.add(new THREE.AmbientLight(0xffffff, 1.0));

        // 2. F칈SICAS
        const world = new CANNON.World(); world.gravity.set(0, -9.82, 0); world.broadphase = new CANNON.SAPBroadphase(world);
        const groundMat = new CANNON.Material(); const wheelMat = new CANNON.Material();
        world.addContactMaterial(new CANNON.ContactMaterial(wheelMat, groundMat, { friction: 3, restitution: 0 }));
        
        const gb = new CANNON.Body({ mass: 0, material: groundMat });
        gb.addShape(new CANNON.Plane()); gb.quaternion.setFromEuler(-Math.PI/2, 0, 0); world.addBody(gb);
        scene.add(new THREE.GridHelper(100, 100));

        // 3. CARGADORES
        const loader = new FBXLoader();
        const chassisGroup = new THREE.Group();
        scene.add(chassisGroup);
        const wheelVisuals = [];

        // Chasis
        loader.load(`./models/${FILE_CHASIS}`, (obj) => {
            obj.scale.set(GLOBAL_SCALE, GLOBAL_SCALE, GLOBAL_SCALE);
            obj.rotation.y = Math.PI; // Mirar al frente
            
            // Fix visual para que se vea por ambos lados
            obj.traverse(c => { if(c.isMesh) { c.material.side = THREE.DoubleSide; } });
            
            chassisGroup.add(obj);
        });

        // Rueda (Con Auto-Centrado estricto)
        loader.load(`./models/${FILE_RUEDA}`, (raw) => {
            // Encontrar malla y centrarla a la fuerza
            let mesh = null;
            raw.traverse(c => { if(c.isMesh && !mesh) mesh = c; });

            if(mesh) {
                mesh.geometry.center(); // ESTO EVITA QUE GIRE PANDEADA
                
                for(let i=0; i<4; i++) {
                    const w = new THREE.Mesh(mesh.geometry, mesh.material);
                    
                    // Escala global + ruedas traseras grandes
                    let s = GLOBAL_SCALE;
                    if(i>=2) s *= 1.3; 
                    w.scale.set(s,s,s);
                    
                    scene.add(w);
                    wheelVisuals.push(w);
                }
            }
        });

        // Veh칤culo F칤sico
        const chassisBody = new CANNON.Body({ mass: 150, material: groundMat });
        chassisBody.addShape(new CANNON.Box(new CANNON.Vec3(0.8*GLOBAL_SCALE, 0.25*GLOBAL_SCALE, 2.2*GLOBAL_SCALE)), new CANNON.Vec3(0, 0.5, 0));
        chassisBody.position.set(0, 3, 0); chassisBody.angularDamping = 0.5;

        const vehicle = new CANNON.RaycastVehicle({ chassisBody: chassisBody, indexRightAxis: 0, indexUpAxis: 1, indexForwardAxis: 2 });
        const wOpts = { radius: 0.4 * GLOBAL_SCALE, directionLocal: new CANNON.Vec3(0,-1,0), suspensionStiffness: 40, suspensionRestLength: 0.5, frictionSlip: 2, dampingRelaxation: 2.3, dampingCompression: 4.4, maxSuspensionForce: 100000, axleLocal: new CANNON.Vec3(-1,0,0), chassisConnectionPointLocal: new CANNON.Vec3(0,0,0), maxSuspensionTravel: 0.3, useCustomSlidingRotationalSpeed: true, customSlidingRotationalSpeed: -30 };

        // A침adir 4 ruedas (Posici칩n inicial)
        for(let i=0; i<4; i++) vehicle.addWheel(wOpts);
        vehicle.addToWorld(world);

        // --- SISTEMA DE CALIBRACI칍N ---
        function updateCalibration() {
            // Leer sliders
            cal.x = parseFloat(document.getElementById('sl-x').value) * GLOBAL_SCALE;
            cal.y = parseFloat(document.getElementById('sl-y').value) * GLOBAL_SCALE;
            cal.z = parseFloat(document.getElementById('sl-z').value) * GLOBAL_SCALE;
            cal.visualY = parseFloat(document.getElementById('sl-vy').value) * GLOBAL_SCALE;
            cal.rotX = parseFloat(document.getElementById('sl-rx').value);

            // Actualizar etiquetas
            document.getElementById('val-x').innerText = (cal.x / GLOBAL_SCALE).toFixed(2);
            document.getElementById('val-y').innerText = (cal.y / GLOBAL_SCALE).toFixed(2);
            document.getElementById('val-z').innerText = (cal.z / GLOBAL_SCALE).toFixed(2);
            document.getElementById('val-vy').innerText = (cal.visualY / GLOBAL_SCALE).toFixed(2);
            document.getElementById('val-rx').innerText = cal.rotX.toFixed(2);

            // Aplicar a F칤sicas (Mover ruedas)
            // Front Left
            vehicle.wheelInfos[0].chassisConnectionPointLocal.set(cal.x, cal.y, cal.z);
            // Front Right
            vehicle.wheelInfos[1].chassisConnectionPointLocal.set(-cal.x, cal.y, cal.z);
            // Rear Left
            vehicle.wheelInfos[2].chassisConnectionPointLocal.set(cal.x, cal.y, -cal.z);
            // Rear Right
            vehicle.wheelInfos[3].chassisConnectionPointLocal.set(-cal.x, cal.y, -cal.z);

            // Aplicar a Visuales (Mover chasis y rotar ruedas)
            chassisGroup.position.y = cal.visualY; // Offset visual relativo a f칤sicas
            
            wheelVisuals.forEach(w => w.rotation.x = cal.rotX);
        }

        // --- CONTROLES SIMPLES ---
        window.onkeydown = (e) => {
            const k = e.key.toLowerCase();
            if(k==='w') keys.w=1; if(k==='s') keys.s=1; if(k==='a') keys.a=1; if(k==='d') keys.d=1;
        };
        window.onkeyup = (e) => {
            const k = e.key.toLowerCase();
            if(k==='w') keys.w=0; if(k==='s') keys.s=0; if(k==='a') keys.a=0; if(k==='d') keys.d=0;
        };
        // Botones pantalla
        const bind = (id, k) => {
            const el = document.getElementById(id);
            el.onmousedown = el.ontouchstart = (e)=>{e.preventDefault(); keys[k]=1; el.style.background='white'; el.style.color='black';};
            el.onmouseup = el.onmouseleave = el.ontouchend = (e)=>{e.preventDefault(); keys[k]=0; el.style.background='rgba(255,255,255,0.1)'; el.style.color='white';};
        };
        bind('btn-gas','w'); bind('btn-brake','s'); bind('btn-left','a'); bind('btn-right','d');

        // --- LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            updateCalibration(); // APLICAR SLIDERS CADA FRAME

            const gas = keys.w; 
            const brake = keys.s;
            const steer = keys.a ? 1 : (keys.d ? -1 : 0);

            const force = 2000 * GLOBAL_SCALE;
            vehicle.applyEngineForce(-gas * force, 2); vehicle.applyEngineForce(-gas * force, 3);
            vehicle.setBrake(brake * 100, 0); vehicle.setBrake(brake * 100, 1);
            vehicle.setBrake(brake * 100, 2); vehicle.setBrake(brake * 100, 3);
            vehicle.setSteeringValue(steer * 0.5, 0); vehicle.setSteeringValue(steer * 0.5, 1);

            world.fixedStep();

            // Sync Chasis
            chassisGroup.position.copy(chassisBody.position);
            // Aplicar el offset visual localmente
            const localOffset = new THREE.Vector3(0, cal.visualY, 0);
            localOffset.applyQuaternion(chassisBody.quaternion);
            chassisGroup.position.add(localOffset);
            
            chassisGroup.quaternion.copy(chassisBody.quaternion);

            // Sync Ruedas
            for(let i=0; i<4; i++){
                vehicle.updateWheelTransform(i);
                if(wheelVisuals[i]) {
                    wheelVisuals[i].position.copy(vehicle.wheelInfos[i].worldTransform.position);
                    wheelVisuals[i].quaternion.copy(vehicle.wheelInfos[i].worldTransform.quaternion);
                    // Rotaci칩n extra para arreglar orientaci칩n de llanta
                    wheelVisuals[i].rotateX(cal.rotX);
                }
            }

            // C치mara
            const camOffset = new THREE.Vector3(0, 4*GLOBAL_SCALE, -8*GLOBAL_SCALE).applyMatrix4(chassisBody.quaternion);
            camera.position.copy(chassisBody.position).add(camOffset);
            camera.lookAt(chassisBody.position);

            document.getElementById('speed-box').innerText = Math.floor(chassisBody.velocity.length()*3.6) + " KM/H";
            renderer.render(scene, camera);
        }
        animate();
        window.onresize = () => { renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); };

    </script>
</body>
</html>
