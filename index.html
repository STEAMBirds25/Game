// --- CONFIGURACIÓN DE SUSPENSIÓN MEJORADA (v10.4 Physics) ---
const vehicle = new CANNON.RaycastVehicle({ 
    chassisBody: chassisBody, 
    indexRightAxis: 0, 
    indexUpAxis: 1, 
    indexForwardAxis: 2 
});

const wOpts = { 
    radius: 0.38, 
    directionLocal: new CANNON.Vec3(0, -1, 0), 
    axleLocal: new CANNON.Vec3(-1, 0, 0),
    suspensionStiffness: 55,          // Más rígida para F1
    suspensionRestLength: 0.5,        // Recorrido equilibrado
    frictionSlip: 3.5,                // Más agarre lateral
    dampingRelaxation: 8.5,           // Control de rebote al subir
    dampingCompression: 5.0,          // Control de impacto al bajar
    maxSuspensionForce: 100000, 
    chassisConnectionPointLocal: new CANNON.Vec3(0, 0, 0), 
    maxSuspensionTravel: 0.25, 
    useCustomSlidingRotationalSpeed: true, 
    customSlidingRotationalSpeed: -30 
};

// Aplicar a las 4 ruedas
wOpts.chassisConnectionPointLocal.set(1.2, 0.1, 1.6); vehicle.addWheel(wOpts); 
wOpts.chassisConnectionPointLocal.set(-1.2, 0.1, 1.6); vehicle.addWheel(wOpts); 
wOpts.chassisConnectionPointLocal.set(1.2, 0.1, -1.6); vehicle.addWheel(wOpts); 
wOpts.chassisConnectionPointLocal.set(-1.2, 0.1, -1.6); vehicle.addWheel(wOpts);

vehicle.addToWorld(world);

// --- DENTRO DEL LOOP ANIMATE (DOWNFORCE OPTIMIZADO) ---
function animate() {
    // ... (tus inputs y UI se quedan igual)

    const force = 3500; // Un poco más de potencia para compensar el peso
    vehicle.applyEngineForce(-inputs.gas * force, 2); 
    vehicle.applyEngineForce(-inputs.gas * force, 3);
    
    // Frenada balanceada
    vehicle.setBrake(inputs.brake * 150, 0); vehicle.setBrake(inputs.brake * 150, 1);
    vehicle.setBrake(inputs.brake * 250, 2); vehicle.setBrake(inputs.brake * 250, 3);
    
    vehicle.setSteeringValue(inputs.steer * 0.75, 0); 
    vehicle.setSteeringValue(inputs.steer * 0.75, 1);

    // Downforce mejorado: Pega el coche al suelo según la velocidad
    const currentSpeed = chassisBody.velocity.length();
    if(currentSpeed > 5) {
        // Fuerza aerodinámica vertical (Aumentada a 200 para v10.4)
        chassisBody.applyLocalForce(new CANNON.Vec3(0, -currentSpeed * 200, 0), new CANNON.Vec3(0, 0, 0));
    }

    world.fixedStep();
    // ... (resto del renderizado)
}
